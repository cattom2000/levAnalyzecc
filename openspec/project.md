# Project Context

## Purpose
市场杠杆分析与风险信号识别系统 (levAnalyzecc) 是一个专业级的金融风险分析平台，旨在通过多维度指标分析市场杠杆水平和系统性风险。该系统整合FINRA融资余额数据、FRED经济数据、Yahoo Finance市场数据和CBOE VIX波动率数据，提供实时风险监控、预警信号和投资决策支持。

### 核心目标
- **市场风险监测**: 实时监控市场杠杆率变化，识别潜在风险累积
- **多维度分析**: 通过7个核心指标综合评估市场健康状况
- **智能预警系统**: 基于量化模型生成4级严重程度的风险信号
- **投资决策支持**: 为投资者和风险管理者提供数据驱动的决策依据
- **学术研究平台**: 为金融市场研究提供完整的数据和分析工具

## Tech Stack

### 核心编程语言
- **Python 3.9+**: 主要开发语言，支持异步编程和科学计算

### 数据处理与分析
- **pandas ≥1.5.0**: 数据处理和分析的核心库
- **numpy ≥1.24.0**: 数值计算和矩阵运算
- **scipy ≥1.10.0**: 科学计算和统计分析
- **scikit-learn ≥1.3.0**: 机器学习和数据挖掘
- **statsmodels ≥0.14.0**: 统计建模和时间序列分析

### 金融数据源
- **yfinance ≥0.2.18**: Yahoo Finance数据API，获取S&P 500和VIX数据
- **pandas-datareader ≥0.10.0**: 多数据源金融数据获取
- **requests ≥2.28.0**: HTTP请求处理，支持API数据获取

### 数据存储与缓存
- **pyarrow ≥12.0.0**: Parquet文件格式支持，高效数据存储
- **requests-cache ≥1.1.0**: HTTP请求缓存，减少API调用
- **sqlalchemy ≥2.0.0**: 数据库ORM和查询抽象层
- **aiosqlite ≥0.21.0**: 异步SQLite数据库操作
- **psycopg2-binary ≥2.9.0**: PostgreSQL数据库连接
- **influxdb-client ≥1.36.0**: InfluxDB时序数据库支持

### Web应用与可视化
- **streamlit ≥1.28.0**: 主要Web框架，用于构建交互式仪表板
- **plotly ≥5.14.0**: 交互式数据可视化图表
- **matplotlib ≥3.6.0**: 静态图表和数据可视化
- **seaborn ≥0.12.0**: 统计数据可视化

### 异步处理与并发
- **aiohttp ≥3.8.0**: 异步HTTP客户端
- **asyncio**: Python原生异步编程支持

### 配置与工具
- **pyyaml ≥6.0**: YAML配置文件解析
- **python-dotenv ≥1.0.0**: 环境变量管理
- **python-dateutil ≥2.8.2**: 日期时间处理
- **jsonschema ≥4.17.0**: JSON数据验证

### 日志与监控
- **loguru ≥0.7.0**: 结构化日志记录

### 开发工具
- **pytest ≥7.2.0**: 单元测试框架
- **pytest-asyncio ≥0.21.0**: 异步测试支持
- **black ≥23.0.0**: 代码格式化工具
- **flake8 ≥6.0.0**: 代码质量检查
- **mypy ≥1.0.0**: 静态类型检查

## Project Conventions

### 代码风格

#### 命名规范
- **文件名**: 使用下划线分隔的小写字母 (snake_case)，如 `leverage_calculator.py`
- **类名**: 使用帕斯卡命名法 (PascalCase)，如 `LeverageRatioCalculator`
- **函数/变量名**: 使用下划线分隔的小写字母，如 `calculate_risk_indicators`
- **常量**: 全大写字母加下划线，如 `MAX_RETRY_ATTEMPTS`
- **私有成员**: 单下划线前缀，如 `_historical_stats`

#### 代码组织
- **模块化设计**: 每个功能模块独立，接口清晰
- **依赖注入**: 通过构造函数注入依赖，提高可测试性
- **异步优先**: 所有I/O操作使用async/await模式
- **类型注解**: 使用Python类型提示增强代码可读性

#### 文档规范
- **Docstring**: 使用Google风格的文档字符串
- **中文注释**: 业务逻辑使用中文注释，便于团队协作
- **API文档**: 详细的参数说明和返回值描述

### 架构模式

#### 分层架构
```
src/
├── data/           # 数据层：数据收集、处理、存储
├── analysis/       # 分析层：计算器、信号生成、风险评估
├── visualization/  # 表现层：图表、仪表板、报告
├── config/         # 配置层：系统配置、环境管理
├── contracts/      # 接口层：抽象接口定义
└── utils/          # 工具层：通用工具、日志、验证
```

#### 设计模式
- **策略模式**: 不同风险计算器实现统一接口 `IRiskCalculator`
- **工厂模式**: 数据源提供者统一创建和管理
- **观察者模式**: 风险信号事件的发布和订阅
- **单例模式**: 全局配置管理器 `SettingsManager`
- **适配器模式**: 不同数据源的统一接口适配

#### 核心原则
- **SOLID原则**: 单一职责、开闭原则、里氏替换、接口隔离、依赖倒置
- **DRY原则**: 避免代码重复，抽象通用功能
- **异步优先**: 所有外部调用使用异步模式
- **缓存优先**: 减少重复计算和API调用

### 测试策略

#### 测试层级
- **单元测试**: 每个计算器和数据处理器的独立测试
- **集成测试**: 多个模块协作的端到端测试
- **性能测试**: 异步操作和数据处理的性能验证
- **数据质量测试**: 数据源质量和计算准确性验证

#### 测试工具
- **pytest**: 主要测试框架
- **pytest-asyncio**: 异步函数测试支持
- **Mock对象**: 模拟外部API调用和数据库操作
- **测试数据**: 使用固定测试数据集确保结果一致性

#### 测试覆盖率
- **目标覆盖率**: ≥80%
- **核心模块**: ≥95%
- **关键算法**: 100%

### Git工作流

#### 分支策略
- **主分支**: `main` - 生产环境代码
- **开发分支**: `001-market-leverage-analysis` - 当前开发分支
- **功能分支**: `feature/功能名称` - 新功能开发
- **修复分支**: `hotfix/问题描述` - 紧急修复

#### 提交规范
- **格式**: `类型(范围): 简短描述`
- **类型**: feat(新功能)、fix(修复)、docs(文档)、style(格式)、refactor(重构)、test(测试)、chore(构建)
- **示例**: `feat(calculator): 添加脆弱性指数计算功能`

#### 代码审查
- **所有PR必须审查**: 至少一人审查通过
- **自动化检查**: 代码格式、静态分析、测试覆盖率
- **文档同步**: 代码变更必须更新相关文档

## Domain Context

### 金融领域知识

#### 杠杆分析核心概念
- **融资余额 (Margin Debt)**: 投资者通过融资购买的证券价值
- **市场杠杆率**: 融资余额与市场总市值的比率，反映市场整体杠杆水平
- **杠杆净值**: `Leverage_Net = Debit Balances - (Credit Cash + Credit Margin)`

#### 风险指标体系
- **7个核心指标**: 市场杠杆率、货币供应比率、杠杆变化率、投资者净值、脆弱性指数、VIX分析、综合风险信号
- **4级风险分级**: INFO(信息)、WARNING(警告)、ALERT(警报)、CRITICAL(严重)
- **Z分数分析**: 基于历史数据的标准差分析，识别异常水平

#### 历史危机模式
- **互联网泡沫 (1999-2002)**: 杠杆快速上升后的崩盘
- **金融危机 (2007-2009)**: 杠杆去化和流动性危机
- **疫情冲击 (2020)**: 快速下跌后的V型恢复
- **通胀高企 (2021-2023)**: 加息周期的杠杆收缩

### 数据源特性

#### FINRA融资数据
- **更新频率**: 月度更新，1-2个工作日延迟
- **历史覆盖**: 1997年1月至今
- **数据质量**: 95%+覆盖率，误差<0.1%
- **关键字段**: 借方余额、贷方余额、净融资额、自由信用余额

#### FRED经济数据
- **API限制**: 每分钟120次请求
- **支持指标**: FEDFUNDS(联邦基金利率)、GS10(10年期国债)、M2SL(M2货币供应)
- **历史覆盖**: 利率数据(1954年至今)、M2数据(1959年至今)

#### 市场数据
- **S&P 500**: 市场基准指数，计算总市值
- **VIX指数**: CBOE波动率指数，市场恐慌情绪指标
- **更新频率**: 日度数据

## Important Constraints

### 技术约束

#### 性能要求
- **API限制**: FRED每分钟120次请求，需实现速率限制
- **内存使用**: 最大2GB内存使用限制
- **响应时间**: 仪表板加载时间<3秒
- **并发处理**: 支持最多10个并发请求

#### 数据质量
- **完整性要求**: 数据覆盖率>95%
- **准确性要求**: 计算误差<0.1%
- **时效性要求**: 数据更新延迟<24小时

#### 安全约束
- **API密钥管理**: 敏感信息使用环境变量存储
- **数据加密**: 缓存数据可选择性加密
- **访问控制**: 支持用户权限管理
- **审计日志**: 关键操作需要记录审计日志

### 业务约束

#### 监管合规
- **数据来源**: 使用公开可得的金融数据
- **投资建议**: 提供风险分析而非具体投资建议
- **风险披露**: 明确系统局限性和风险提示

#### 运行环境
- **Python版本**: 3.9+
- **操作系统**: Linux/macOS/Windows
- **数据库**: SQLite(开发)/PostgreSQL(生产)
- **浏览器**: 现代浏览器，支持JavaScript

## External Dependencies

### 金融数据API

#### FRED (Federal Reserve Economic Data)
- **用途**: 获取美国宏观经济数据
- **关键数据**: 联邦基金利率、M2货币供应量、国债收益率
- **API限制**: 每分钟120次请求，需要API密钥
- **更新延迟**: 1-2个工作日

#### Yahoo Finance
- **用途**: 获取市场数据和价格信息
- **关键数据**: S&P 500指数、VIX波动率指数
- **访问方式**: yfinance库，无需API密钥
- **限制**: 建议每分钟30次请求

#### FINRA (Financial Industry Regulatory Authority)
- **用途**: 融融余额和信用数据
- **访问方式**: 预置数据文件 + 备用API
- **数据质量**: 经过清洗和验证的高质量数据
- **更新频率**: 月度更新

### 系统依赖

#### 缓存系统
- **HTTP缓存**: requests-cache，减少API调用
- **数据库缓存**: SQLite/PostgreSQL，持久化数据存储
- **内存缓存**: pandas DataFrame缓存

#### 监控与日志
- **结构化日志**: loguru，支持JSON格式输出
- **性能监控**: 自定义性能指标收集
- **错误追踪**: 异常捕获和分类处理

### 第三方服务

#### 可选依赖
- **InfluxDB**: 时序数据库，用于高频数据存储
- **PostgreSQL**: 生产环境主数据库
- **Redis**: 分布式缓存和会话存储

#### 开发工具
- **GitHub**: 代码托管和版本控制
- **pytest**: 测试框架和覆盖率报告
- **black**: 代码格式化和风格统一
- **mypy**: 静态类型检查和IDE支持
