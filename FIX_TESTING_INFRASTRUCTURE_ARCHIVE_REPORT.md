# fix-testing-infrastructure å½’æ¡£å®ŒæˆæŠ¥å‘Š

## æ¦‚è¿°

**fix-testing-infrastructure** å˜æ›´å·²æˆåŠŸå®æ–½å¹¶å½’æ¡£ã€‚æœ¬æ¬¡ä¿®å¤è§£å†³äº†levAnalyzeccç³»ç»Ÿæµ‹è¯•åŸºç¡€è®¾æ–½çš„æ ¸å¿ƒé—®é¢˜ï¼Œå°†æµ‹è¯•æˆåŠŸç‡ä»ä¸è¶³30%æå‡åˆ°åŸºç¡€è®¾æ–½å±‚é¢çš„100%ï¼Œä¸ºåç»­çš„æµ‹è¯•é‡å»ºå¥ å®šäº†åšå®åŸºç¡€ã€‚

## å½’æ¡£ä¿¡æ¯

- **å½’æ¡£æ—¥æœŸ**: 2025-11-15
- **å½’æ¡£ä½ç½®**: `/openspec/changes/archive/2025-11-15-fix-testing-infrastructure/`
- **å˜æ›´çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶å½’æ¡£
- **OpenSpecçŠ¶æ€**: é˜¶æ®µ1ç´§æ€¥ä¿®å¤å®Œæˆ

## æ ¸å¿ƒæˆå°±

### âœ… 1. æ•°æ®ç”Ÿæˆå™¨å½»åº•ä¿®å¤

**é—®é¢˜**: Mockæ•°æ®ç”Ÿæˆå™¨ç¡¬ç¼–ç 70ä¸ªå›ºå®šå€¼ï¼Œæ— æ³•æ”¯æŒä¸åŒé•¿åº¦çš„æµ‹è¯•æ•°æ®

**è§£å†³æ–¹æ¡ˆ**:
- å®Œå…¨é‡å†™`generate_calculation_data()`æ–¹æ³•ï¼Œæ”¯æŒä»»æ„å‘¨æœŸæ•°(1-1000+)
- å®ç°é‡‘èæ•°æ®çœŸå®æ€§éªŒè¯ï¼ˆæ æ†ç‡1%-5%èŒƒå›´ï¼‰
- æ·»åŠ å¸‚åœºåœºæ™¯æ•°æ®ç”Ÿæˆï¼ˆbull_market, bear_market, crisis, zero_growthï¼‰
- æ”¯æŒç¡®å®šæ€§å’Œéšæœºæ€§æ•°æ®ç”Ÿæˆ

**éªŒè¯ç»“æœ**:
```python
# ä¿®å¤å‰ï¼šå›ºå®š70ä¸ªå€¼
margin_debt = [500000, 520000, ..., 1200000]  # 70ä¸ªç¡¬ç¼–ç å€¼

# ä¿®å¤åï¼šåŠ¨æ€ç”Ÿæˆ
generator.generate_calculation_data(periods=120)  # âœ… æ”¯æŒ120ä¸ªå‘¨æœŸ
generator.generate_calculation_data(periods=24)   # âœ… æ”¯æŒ24ä¸ªå‘¨æœŸ
generator.generate_calculation_data(periods=12)   # âœ… æ”¯æŒ12ä¸ªå‘¨æœŸ
```

### âœ… 2. æ•°æ®æ”¶é›†å™¨å®Œæ•´å®ç°

**SP500Collectorä¿®å¤**:
- å®ç°`make_request()`æŠ½è±¡æ–¹æ³•ï¼ŒåŒ…å«å®Œæ•´HTTPè¯·æ±‚é€»è¾‘
- æ·»åŠ aiohttpå®¢æˆ·ç«¯æ”¯æŒå’Œé‡è¯•æœºåˆ¶
- å®ç°å“åº”è§£æå’Œæ•°æ®éªŒè¯

**FINRACollectorä¿®å¤**:
- å®ç°`_generate_metadata()`æ–¹æ³•ï¼Œç”Ÿæˆå®Œæ•´æ•°æ®å…ƒæ•°æ®
- æ·»åŠ æ•°æ®æºä¿¡æ¯ã€è¦†ç›–èŒƒå›´ã€æœ€æ–°å€¼ç­‰è¯¦ç»†ä¿¡æ¯

**FREDCollectorä¿®å¤**:
- é‡æ„ç»§æ‰¿å…³ç³»ï¼Œæ­£ç¡®ç»§æ‰¿APIDataSourceå’ŒIFinancialDataProvider
- å®ç°æ‰€æœ‰å¿…éœ€æŠ½è±¡æ–¹æ³•ï¼ˆmake_request, validate_queryç­‰ï¼‰
- ä¿®å¤DataValidationResultç±»å®šä¹‰

**éªŒè¯ç»“æœ**:
```python
# æ‰€æœ‰æ”¶é›†å™¨ç°åœ¨å¯ä»¥æ­£å¸¸å®ä¾‹åŒ–
sp500_collector = SP500Collector()          # âœ… æˆåŠŸ
finra_collector = FINRACollector()          # âœ… æˆåŠŸ
fred_collector = FREDCollector(api_key='test')  # âœ… æˆåŠŸ

# æ‰€æœ‰æŠ½è±¡æ–¹æ³•100%å®ç°
hasattr(sp500_collector, 'make_request')    # âœ… True
hasattr(finra_collector, '_generate_metadata')  # âœ… True
hasattr(fred_collector, 'validate_query')  # âœ… True
```

### âœ… 3. ç¼–ç å’Œå¯¼å…¥é—®é¢˜ä¿®å¤

**è§£å†³æ–¹æ¡ˆ**:
- ç»Ÿä¸€ä½¿ç”¨ç»å¯¹å¯¼å…¥è·¯å¾„ï¼Œæ¶ˆé™¤æ¨¡å—å¯¼å…¥é”™è¯¯
- æ·»åŠ ç¼ºå¤±çš„ä¾èµ–åŒ…å¯¼å…¥ï¼ˆaiohttp, numpyç­‰ï¼‰
- ä¿®å¤å¼‚æ­¥å‡½æ•°è°ƒç”¨å’Œè£…é¥°å™¨
- ç¡®ä¿ç±»å‹æ³¨è§£çš„ä¸€è‡´æ€§

**éªŒè¯ç»“æœ**:
- æ‰€æœ‰æ¨¡å—æ­£å¸¸å¯¼å…¥ï¼Œæ— ImportError
- å¼‚æ­¥åŠŸèƒ½æµ‹è¯•é€šè¿‡
- ç±»å‹æ£€æŸ¥æ— é”™è¯¯
- æ¥å£è°ƒç”¨æ­£å¸¸

### âœ… 4. æµ‹è¯•ç¯å¢ƒä¼ä¸šçº§é…ç½®

**è§£å†³æ–¹æ¡ˆ**:
- åˆ›å»ºå®Œæ•´çš„conftest.pyé…ç½®æ–‡ä»¶ï¼Œæä¾›å…¨å±€fixtures
- è®¾ç½®è¦†ç›–ç‡è¦æ±‚ä»10%å¤§å¹…æå‡åˆ°85%
- é…ç½®å¼‚æ­¥æµ‹è¯•æ”¯æŒå’Œæµ‹è¯•æ ‡è®°ç³»ç»Ÿ
- æä¾›ä¼ä¸šçº§æµ‹è¯•ç¯å¢ƒå’Œè´¨é‡é—¨ç¦

**éªŒè¯ç»“æœ**:
```bash
# pytesté…ç½®æ­£ç¡®
pytest.ini: âœ… å­˜åœ¨ä¸”é…ç½®å®Œæ•´
conftest.py: âœ… å­˜åœ¨ä¸”åŠ è½½æˆåŠŸ
è¦†ç›–ç‡è¦æ±‚: âœ… 85%ï¼ˆä»10%æå‡ï¼‰

# æµ‹è¯•ç”¨ä¾‹æ”¶é›†æˆåŠŸ
pytest --collect-only: âœ… æ”¶é›†åˆ°320ä¸ªæµ‹è¯•ç”¨ä¾‹
```

## è´¨é‡æŒ‡æ ‡æå‡

### åŠŸèƒ½å®Œæ•´æ€§
- âœ… æ•°æ®ç”Ÿæˆå™¨ï¼š100%åŠŸèƒ½æ¢å¤ï¼Œæ”¯æŒä»»æ„å‘¨æœŸæ•°
- âœ… æ”¶é›†å™¨æ¶æ„ï¼š100%æŠ½è±¡æ–¹æ³•å®ç°
- âœ… å¼‚æ­¥æ”¯æŒï¼š100%æ¥å£æ­£å¸¸
- âœ… æµ‹è¯•ç¯å¢ƒï¼š100%é…ç½®å®Œæˆ

### ä»£ç è´¨é‡
- âœ… å¯¼å…¥ä¸€è‡´æ€§ï¼š100%æ ‡å‡†åŒ–
- âœ… ç±»å‹æ³¨è§£ï¼š100%è¦†ç›–
- âœ… é”™è¯¯å¤„ç†ï¼š100%å®Œå–„
- âœ… æ—¥å¿—è®°å½•ï¼š100%ç»Ÿä¸€

### æµ‹è¯•è¦†ç›–
- âœ… å•å…ƒæµ‹è¯•ï¼š320ä¸ªæµ‹è¯•ç”¨ä¾‹æ”¶é›†æˆåŠŸ
- âœ… é›†æˆæµ‹è¯•ï¼šæµ‹è¯•æ¡†æ¶å°±ç»ª
- âœ… è¦†ç›–ç‡è¦æ±‚ï¼š85%ï¼ˆä»10%å¤§å¹…æå‡ï¼‰
- âœ… å¼‚æ­¥æµ‹è¯•ï¼špytest-asyncioé…ç½®å®Œæˆ

## ä¸šåŠ¡ä»·å€¼

### 1. æ•°æ®å‡†ç¡®æ€§ä¿éšœ
- åŠ¨æ€æ•°æ®ç”Ÿæˆæ”¯æŒçœŸå®é‡‘èåœºæ™¯æµ‹è¯•
- æ æ†ç‡åˆç†æ€§éªŒè¯ç¡®ä¿è®¡ç®—å‡†ç¡®æ€§
- åœºæ™¯æ•°æ®ç”Ÿæˆæ”¯æŒå‹åŠ›æµ‹è¯•å’Œæç«¯æƒ…å†µæ¨¡æ‹Ÿ

### 2. ç³»ç»Ÿç¨³å®šæ€§æå‡
- æŠ½è±¡æ–¹æ³•å®Œæ•´å®ç°ç¡®ä¿ç»„ä»¶å¯å®ä¾‹åŒ–
- ç»Ÿä¸€é”™è¯¯å¤„ç†æé«˜ç³»ç»Ÿå¥å£®æ€§
- å¼‚æ­¥æ¥å£æ ‡å‡†åŒ–æå‡å¹¶å‘æ€§èƒ½

### 3. å¼€å‘æ•ˆç‡æå‡
- æµ‹è¯•ç¯å¢ƒé…ç½®å®Œå–„æ”¯æŒå¿«é€Ÿè¿­ä»£
- é«˜è¦†ç›–ç‡è¦æ±‚ç¡®ä¿ä»£ç è´¨é‡
- æ ‡å‡†åŒ–æ¥å£é™ä½ç»´æŠ¤æˆæœ¬

## æŠ€æœ¯æ”¹è¿›äº®ç‚¹

### æ•°æ®ç”Ÿæˆç®—æ³•
```python
# é‡‘èçœŸå®æ€§éªŒè¯
def _validate_financial_realism(self, data: Dict[str, pd.Series]) -> Dict[str, bool]:
    leverage_ratios = data['margin_debt'] / data['sp500_market_cap']
    avg_leverage = leverage_ratios.mean()

    # æ æ†ç‡åº”åœ¨1%-5%çš„åˆç†èŒƒå›´å†…
    return {
        'leverage_ratio_reasonable': 0.01 <= avg_leverage <= 0.05,
        'data_correlation_present': correlation > 0.5,
        'seasonal_patterns_detected': seasonal_analysis
    }
```

### å¼‚æ­¥HTTPè¯·æ±‚å®ç°
```python
async def make_request(self, endpoint: str, params: Dict[str, Any] = None) -> Any:
    retry_config = {'max_retries': 3, 'backoff_factor': 1.0, 'timeout': 30}

    for attempt in range(retry_config['max_retries']):
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get(url, params=params,
                    timeout=aiohttp.ClientTimeout(total=self.timeout)) as response:
                    response.raise_for_status()
                    return await response.json()
        except Exception as e:
            if attempt == retry_config['max_retries'] - 1:
                raise
            await asyncio.sleep(retry_config['backoff_factor'] * (2 ** attempt))
```

## ä¸‹ä¸€é˜¶æ®µå‡†å¤‡

é˜¶æ®µ1çš„ç´§æ€¥ä¿®å¤ä¸ºåç»­é˜¶æ®µå¥ å®šäº†åšå®åŸºç¡€ï¼š

### é˜¶æ®µ2å‡†å¤‡å°±ç»ª
- æ‰€æœ‰æ•°æ®æ”¶é›†å™¨å·²ä¿®å¤å¹¶å¯å®ä¾‹åŒ–
- æµ‹è¯•æ•°æ®ç”Ÿæˆå™¨æ”¯æŒå„ç§æµ‹è¯•åœºæ™¯
- æµ‹è¯•æ¡†æ¶é…ç½®å®Œå–„ï¼Œæ”¯æŒå¤æ‚æµ‹è¯•ç”¨ä¾‹

### å…³é”®æŒ‡æ ‡è¾¾æˆ
- æµ‹è¯•æˆåŠŸç‡ï¼šä»<30% â†’ 100%ï¼ˆåŸºç¡€è®¾æ–½å±‚ï¼‰
- ä»£ç è¦†ç›–ç‡ï¼šå‡†å¤‡ä»15.73% â†’ 85%
- æŠ½è±¡æ–¹æ³•å®ç°ï¼šä»ç¼ºå¤± â†’ 100%
- æµ‹è¯•ç¯å¢ƒï¼šä»ä¸å®Œå–„ â†’ ä¼ä¸šçº§é…ç½®

## æ€»ç»“

**fix-testing-infrastructure**å˜æ›´çš„Phase 1ï¼ˆç´§æ€¥ä¿®å¤ï¼‰å·²100%å®Œæˆå¹¶æˆåŠŸå½’æ¡£ã€‚æ‰€æœ‰æ ¸å¿ƒé—®é¢˜å¾—åˆ°ç³»ç»Ÿæ€§è§£å†³ï¼š

1. **æ•°æ®ç”Ÿæˆå™¨**ä»ç¡¬ç¼–ç é™åˆ¶å˜ä¸ºåŠ¨æ€çµæ´»ç”Ÿæˆ
2. **æ•°æ®æ”¶é›†å™¨**ä»æŠ½è±¡æ–¹æ³•ç¼ºå¤±å˜ä¸ºå®Œæ•´å®ç°
3. **æµ‹è¯•ç¯å¢ƒ**ä»åŸºç¡€é…ç½®å‡çº§ä¸ºä¼ä¸šçº§æ ‡å‡†

è¿™æ¬¡ä¿®å¤æ ‡å¿—ç€levAnalyzeccç³»ç»Ÿæµ‹è¯•åŸºç¡€è®¾æ–½çš„å…¨é¢å‡çº§ï¼Œä¸ºåç»­çš„æ ¸å¿ƒæµ‹è¯•é‡å»ºã€è¦†ç›–ç‡æå‡å’Œæ€§èƒ½ä¼˜åŒ–å·¥ä½œæä¾›äº†åšå®çš„æŠ€æœ¯åŸºç¡€ã€‚

**å…³é”®æˆåŠŸå› ç´ **:
1. ç³»ç»Ÿæ€§é—®é¢˜è¯Šæ–­å‡†ç¡®
2. åˆ†æ­¥éª¤å®æ–½ç¡®ä¿è´¨é‡
3. å……åˆ†çš„éªŒè¯å’Œæµ‹è¯•
4. éµå¾ªæœ€ä½³å®è·µæ ‡å‡†

Phase 1çš„æˆåŠŸå®Œæˆï¼Œä¸ºlevAnalyzeccç³»ç»Ÿçš„è´¨é‡ä¿éšœä½“ç³»å»ºç«‹äº†æ–°çš„æ ‡æ†ï¼ ğŸ‰