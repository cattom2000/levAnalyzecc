# Feature Specification: 市场杠杆分析与风险信号识别系统

**Feature Branch**: `001-market-leverage-analysis`
**Created**: 2025-01-10
**Status**: Draft
**Input**: User description: "通过以往的金融数据的分析功能和可视化，识别市场风险信号和投资机会。核心分析指标包括市场杠杆率、货币供应比率、利率成本分析、杠杆变化率、投资者净资产和脆弱性指数。支持多图表展示、历史危机时期分析和交互式可视化。"

## Clarifications

### Session 2025-01-10

- Q: 数据时间段覆盖范围和分段策略 → A: 分阶段数据策略：Part1核心指标覆盖1997-01至今（95%+覆盖），Part2分析指标覆盖2010-02至2025-09（95%+覆盖）
- Q: 脆弱性指数算法实现方式 → A: 集成用户提供的算法文案，系统实现杠杆Z-score和VIX Z-score的标准化计算，确保算法透明度
- Q: FINRA数据源特殊处理方式 → A: 混合策略：主要使用用户提供的预置数据源，同时保留FINRA API作为备用获取方式

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 市场杠杆率基础分析 (Priority: P1)

用户（投资者/分析师）需要通过融资余额与S&P 500总市值的比率来评估市场整体杠杆水平，识别潜在的市场风险。用户能够查看历史趋势、关键阈值和异常波动点。

**Why this priority**: 市场杠杆率是评估系统性风险的核心指标，直接影响投资决策和风险控制策略，是整个分析系统的基础。

**Independent Test**: 可以独立测试数据获取、比率计算和基础可视化功能，提供完整的市场杠杆率分析报告。

**Acceptance Scenarios**:

1. **Given** 用户访问市场杠杆率分析页面，**When** 选择时间范围2020-2024年，**Then** 系统显示Margin Debt/S&P 500市值比率的时间序列图表，包含历史平均线和危险阈值
2. **Given** 用户查看杠杆率数据，**When** 比率超过历史75%分位数，**Then** 系统自动标记为高风险并显示警告提示

---

### User Story 2 - 多维度风险指标综合分析 (Priority: P1)

用户需要综合分析多个风险指标，包括货币供应比率、利率成本、杠杆变化率和脆弱性指数，通过Z-score分析来识别市场异常状态和潜在转折点。

**Why this priority**: 单一指标可能产生误导信号，多维度综合分析能提供更准确和全面的风险评估，降低误判率。

**Independent Test**: 可以独立测试各指标计算、Z-score标准化和综合评分算法，生成多维风险评估报告。

**Acceptance Scenarios**:

1. **Given** 用户查看综合风险分析，**When** 系统计算杠杆Z-score和VIX Z-score，**Then** 显示脆弱性指数图表并用颜色编码风险等级（绿色=低风险，黄色=中等风险，红色=高风险）
2. **Given** 用户分析杠杆变化率，**When** YoY增长率超过15%或低于-10%，**Then** 系统高亮显示异常期间并提供历史相似情况对比

---

### User Story 3 - 历史危机时期对比分析 (Priority: P2)

用户需要将当前市场状况与历史重大危机时期（互联网泡沫、金融危机、疫情冲击、高通胀时期）进行对比分析，识别相似模式和潜在风险。

**Why this priority**: 历史对比分析有助于识别当前市场的相对风险水平，为投资决策提供重要的参考框架。

**Independent Test**: 可以独立测试历史数据段定义、模式匹配算法和对比分析功能，生成历史对比报告。

**Acceptance Scenarios**:

1. **Given** 用户选择历史危机对比功能，**When** 选择2008年金融危机时期作为对比基准，**Then** 系统并排显示当前与2008年的关键指标对比图表
2. **Given** 用户查看模式识别结果，**When** 系统检测到与历史危机相似的指标组合，**Then** 显示相似度评分和风险预警信息

---

### User Story 4 - 交互式可视化与报告生成 (Priority: P2)

用户需要通过交互式图表进行深度分析，支持时间范围选择、数据过滤、指标切换，并能生成包含关键发现的分析报告用于投资决策。

**Why this priority**: 交互式功能大大提升了分析的灵活性和深度，报告生成功能使分析结果能够有效传达给决策者。

**Independent Test**: 可以独立测试Plotly交互图表功能、数据过滤逻辑和PDF报告生成功能。

**Acceptance Scenarios**:

1. **Given** 用户在交互式图表中，**When** 拖动时间轴选择2015-2020年，**Then** 图表实时更新显示选定时间段的数据和趋势线
2. **Given** 用户完成分析后，**When** 点击生成报告按钮，**Then** 系统导出包含关键图表、风险指标摘要和投资建议的PDF报告

---

### Edge Cases

- 当数据源出现延迟或缺失时，系统如何显示和处理？
- 当市场出现极端波动导致计算结果异常时，系统如何识别和标记？
- 用户选择的超长时间范围（如超过30年）如何影响系统性能和显示效果？
- 当多个指标给出冲突信号时，系统如何综合判断和呈现？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须支持混合数据源策略，主要使用用户提供的预置FINRA融资余额数据，同时保留FINRA API作为备用获取方式
- **FR-002**: 系统必须能够获取S&P 500指数历史数据并计算总市值，支持从1997年1月开始的Part1数据段和从2010年2月开始的Part2数据段
- **FR-003**: 系统必须能够获取FRED利率数据（联邦基金利率、10年期国债收益率）
- **FR-004**: 系统必须能够获取M2货币供应量历史数据
- **FR-005**: 系统必须能够获取CBOE VIX波动率指数数据（1990年至今）
- **FR-006**: 系统必须能够获取Yahoo Finance数据（黄金价格、BTC价格等）
- **FR-007**: 系统必须实现市场杠杆率计算（Margin Debt / S&P 500总市值）
- **FR-008**: 系统必须实现货币供应比率计算（Margin Debt / M2）
- **FR-009**: 系统必须实现杠杆变化率计算（年同比增长率YoY %）
- **FR-010**: 系统必须实现投资者净资产计算（现金余额 - 借方余额）
- **FR-011**: 系统必须集成用户提供的算法文案实现脆弱性指数计算（杠杆Z-score - VIX Z-score），确保算法透明度和可验证性
- **FR-012**: 系统必须支持多图表展示（时间序列图、散点图、热力图、相关性矩阵）
- **FR-013**: 系统必须支持历史危机时期标记和对比分析功能
- **FR-014**: 系统必须提供交互式可视化功能（时间范围选择、数据过滤、指标切换）
- **FR-015**: 系统必须实现基于Plotly的动态图表和响应式设计
- **FR-016**: 系统必须能够生成包含风险信号和投资建议的分析报告
- **FR-017**: 系统必须支持数据质量检查和异常值检测
- **FR-018**: 系统必须支持数据缓存和增量更新机制

### Key Entities

- **融资余额数据**: 主要来自用户提供的预置FINRA融资余额数据，包含借方余额、贷方余额、净融资额、时间戳，支持1997年1月至今的Part1数据段和2010年2月至2025年9月的Part2分析数据段
- **市场指数数据**: S&P 500指数的价格、市值、成交量数据，用于计算市场杠杆率
- **利率数据**: 联邦基金利率、10年期国债收益率等，用于分析融资成本与市场关系
- **货币供应数据**: M2货币供应量，用于计算货币供应比率和流动性分析
- **波动率数据**: VIX指数及其历史数据，用于市场恐慌情绪和风险溢价分析
- **杠杆指标**: 包含市场杠杆率、货币供应比率、杠杆变化率等衍生指标
- **脆弱性指数**: 基于用户提供的算法文案实现的核心指标，通过杠杆Z-score与VIX Z-score的差值计算市场脆弱性，算法透明且可验证
- **风险信号**: 基于指标阈值和异常检测生成的市场预警信息
- **历史危机数据**: 预定义的危机时期（互联网泡沫、金融危机等）的关键指标数据
- **分析报告**: 包含图表、风险摘要和投资建议的结构化输出文档

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 数据获取准确率达到99.9%以上，Part1数据段（1997-01至今）和Part2数据段（2010-02至2025-09）覆盖率均达到95%以上，与官方数据源对比误差<0.1%
- **SC-002**: 交互式图表响应时间在2秒内完成，支持流畅的时间轴拖动和缩放
- **SC-003**: 风险信号识别准确率达到85%以上，基于历史危机时期回测验证
- **SC-004**: 系统能够同时处理至少10个不同时间段的对比分析
- **SC-005**: 历史危机模式匹配相似度评分与实际市场发展符合率达到75%以上
- **SC-006**: 用户完成一次完整分析（数据获取到报告生成）的平均时间不超过5分钟
- **SC-007**: 生成的分析报告包含至少5个关键风险信号和3个投资机会建议
- **SC-008**: 系统支持连续运行无故障时间超过99.5%，数据更新延迟不超过30分钟
